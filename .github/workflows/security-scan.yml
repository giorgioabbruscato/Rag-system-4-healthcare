name: Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install pip-audit
      run: |
        python -m pip install --upgrade pip
        pip install pip-audit
    
    - name: Scan dependencies for vulnerabilities
      run: |
        pip-audit -r requirements.txt
      continue-on-error: true
  
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Check for hardcoded API keys
      run: |
        echo "Checking for potential API keys..."
        
        # Check for common API key patterns
        ! grep -rE "(api[_-]?key|apikey|secret[_-]?key)" --include="*.py" --include="*.sh" . | grep -v "test" | grep -v ".git" || true
        
        # Check for OpenAI keys
        ! grep -rE "sk-[a-zA-Z0-9]{48}" . --exclude-dir=".git" || (echo "Found potential OpenAI API key" && exit 1)
        
        echo "âœ… No hardcoded secrets found"

  code-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install bandit
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml]
    
    - name: Run Bandit security linter
      run: |
        bandit -r src/ api/ scripts/ -f json -o bandit-report.json || true
        bandit -r src/ api/ scripts/ --severity-level medium
      continue-on-error: true
    
    - name: Upload Bandit report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json
